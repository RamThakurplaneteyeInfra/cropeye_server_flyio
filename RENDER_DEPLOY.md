# Deploy CropEye Django API on Render

This project is configured to run on [Render](https://render.com) with **Neon PostgreSQL**. The app uses GeoDjango (PostGIS), Gunicorn, and WhiteNoise. Redis is optional; the app uses in-memory cache when `REDIS_URL` is not set.

## Prerequisites

- A [Render](https://render.com) account
- GitHub repo with this code
- Neon PostgreSQL database with PostGIS (or run `enable_postgis_neon.py` once locally; it also runs on each deploy)

## 1. Connect your repository

1. Go to [Render Dashboard](https://dashboard.render.com) → **New** → **Blueprint**.
2. Connect your GitHub account and select the **cropeye_back_neon_db** repository.
3. Render will detect `render.yaml` in the repo root and create the **farm-management-web** service.

## 2. Set environment variables

In **Render Dashboard** → your **Web Service** → **Environment**:

### Required

| Key | Value | Notes |
|-----|--------|------|
| `DATABASE_URL` | `postgresql://user:pass@host/db?sslmode=require` | Your **Neon** connection string (use **Secret**). |
| `SECRET_KEY` | (random string) | Auto-generated by `render.yaml`; override only if needed. |

### Optional

| Key | Value |
|-----|--------|
| `DEBUG` | `False` (default in blueprint) |
| `REDIS_URL` | Redis connection string (if you add a Render Redis service) |
| `FRONTEND_URL` | Your frontend URL for CORS |
| `ALLOWED_HOSTS` | Override if using a custom domain |

- Use **Secret** for `DATABASE_URL` and `SECRET_KEY`; do not commit them.

## 3. Deploy

1. **Save** environment variables.
2. **Deploy** the service (manual **Deploy** or push to the connected branch).
3. Render builds the Docker image, runs migrations (via `start_server.sh`), and starts Gunicorn.
4. Health checks use `GET /api/health/`.

## 4. URLs

After deploy, your API will be at:

- `https://farm-management-web.onrender.com` (or the URL Render shows)
- `https://farm-management-web.onrender.com/api/health/`
- `https://farm-management-web.onrender.com/swagger/`
- `https://farm-management-web.onrender.com/admin/`

Update `ALLOWED_HOSTS` and `CSRF_TRUSTED_ORIGINS` if you use a **custom domain**.

## 5. Blueprint (`render.yaml`)

- **Service**: `farm-management-web`, Docker, `plan: free`.
- **Database**: External (Neon). Set `DATABASE_URL` in Environment.
- **Redis**: Not included. Add a Render Redis service and set `REDIS_URL` if you want Redis cache.

To use a **Starter** (paid) plan, change `plan: free` to `plan: starter` in `render.yaml`.

## 6. Troubleshooting

| Issue | What to do |
|-------|------------|
| Build fails | Check **Build logs**. Ensure Dockerfile, `requirements_production.txt`, and GDAL deps build. |
| App crashes / 503 | Check **Logs**. Often `DATABASE_URL` missing or invalid, or Neon unreachable. |
| Migrations fail | Ensure Neon has PostGIS (`enable_postgis_neon.py` runs on each deploy). Run it once manually if needed. |
| 400 Bad Request / Host header | Add your Render URL to `ALLOWED_HOSTS` (or use `RENDER_EXTERNAL_HOSTNAME`, which is added automatically). |
| CSRF 403 on frontend | Add your frontend origin to `CORS_ALLOWED_ORIGINS` and `CSRF_TRUSTED_ORIGINS`. |

## 7. Create a superuser

Use **Render Shell** (Dashboard → your service → **Shell**):

```bash
python manage.py createsuperuser
```

Then log in at `https://<your-service>.onrender.com/admin/`.
